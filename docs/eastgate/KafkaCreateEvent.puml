@startuml
'https://plantuml.com/sequence-diagram

autonumber

participant Kafka
box UserManagementService
participant "Listener/Event Consumer" as Listener
participant "KafkaEventFacadeBean" as KafkaEventFacade
participant "AgencyInformationStrategy" as AgencyInformationStrategy
end box

Kafka <- Listener: Polling to consume event
note right
AgencyEventVo : {
   "AgencyId" : ,
   "Id": ,
   "changeType" : "Add/Update/Delete",
   "changedBy" : "",
   "changeTime" : "",
   "metadata" : {},
   "data" : {
       "data" : {},
       "metadata": {},
       "objectType" : {}
   }
}
end note

alt Convert success
   Listener -> Listener : Convert Kafka Event to internal Event
   Listener -> Listener : Validate event
   return AgencyEventVo
else any exception
   Listener -> Listener: Log exception and ignore to commit offset
end


note right
AgencyEventVo : {
'     "agencySettingRequest" : SetAgencySettingsRequestVO,
'     "agencyLicence" : AgencyLicenseUpdateRequestVO
}
end note

group Business Logic
   Listener -> KafkaEventFacade: handleAgencyKafkaEvent

   KafkaEventFacade -> AgencyInformationStrategy: Check if agency existed or not by id
   alt agency not existed
    KafkaEventFacade -> AgencyInformationStrategy: Add Agency
   else existed
    KafkaEventFacade -> Listener: throw NotRetryableException
   end
end
@enduml